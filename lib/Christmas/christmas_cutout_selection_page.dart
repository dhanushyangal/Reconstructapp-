import 'package:flutter/material.dart';
import '../utils/activity_tracker_mixin.dart';
import '../components/nav_logpage.dart';
import 'christmas_coloring_page.dart';
import 'christmas_svg_parser.dart';

class ChristmasCutoutSelectionPage extends StatefulWidget {
  const ChristmasCutoutSelectionPage({super.key});

  @override
  State<ChristmasCutoutSelectionPage> createState() => _ChristmasCutoutSelectionPageState();
}

class _ChristmasCutoutSelectionPageState extends State<ChristmasCutoutSelectionPage>
    with ActivityTrackerMixin, TickerProviderStateMixin {

  // Animation controllers for progress bar
  AnimationController? _progressAnimationController;
  Animation<double>? _progressAnimation;

  // Christmas cutout categories data with SVG paths
  final List<Map<String, dynamic>> _christmasCutouts = [
    {
      'name': 'Reindeer',
      'svgPath': 'M16.3576 355.625C12.4616 351.352 10.1783 345.627 6.06152 333.889C8.30721 321.38 9.56628 314.367 11.812 301.859L14.0574 284.667L28.5704 264.464C21.8123 254.796 20.1392 249.366 20.1912 239.661C19.6041 233.719 20.4793 229.6 23.9701 220.992C16.5935 216.162 15.4336 211.892 16.3576 202.705C19.141 192.806 21.582 188.072 28.5704 182.063C34.0232 179.438 36.4754 179.615 38.0997 187.429C39.0854 195.408 40.0641 198.988 43.0834 202.705C52.1229 198.853 58.1561 198.347 69.7546 198.872L101.081 195.806C114.691 194.021 121.01 191.59 120.523 174.453C120.523 174.453 113.677 159.286 113.677 150.8C113.677 142.314 106.776 147.351 106.776 147.351C96.7832 153.994 89.3366 153.667 75.8884 152.717C58.1009 148.277 43.0834 138.207 40.7833 134.813C38.4831 131.418 48.6948 127.159 60.2253 121.454C70.7001 115.571 77.698 114.604 91.9349 116.471L94.1803 108.477C91.2642 103.903 82.0222 102.345 75.8884 102.345C69.7546 102.345 63.5691 109.967 54.9129 113.405C45.824 116.928 40.7261 117.162 31.6373 113.405C22.7722 112.142 20.2016 109.766 20.1912 102.345C26.1318 101.445 29.9555 102.484 38.0997 108.477C43.6204 109.404 56.775 110.01 48.7791 106.178C40.7833 102.345 34.7569 85.1405 31.6373 71.4655C36.4949 67.6135 38.6126 67.2665 40.7833 71.4655L48.7791 92.052C54.6727 98.7391 58.0602 100.893 64.4422 98.1842C69.3657 93.6053 70.0027 90.4653 66.7424 83.6751C61.8799 77.306 60.948 73.1369 60.2253 65.3881C62.2133 61.0154 64.0568 60.0885 69.7546 63.4718L78.9553 83.6751C83.9155 95.2934 88.0428 98.5797 98.0139 98.1842C98.0139 98.1842 104.093 100.429 104.093 92.052C104.093 83.6751 101.081 75.6814 101.081 75.6814L78.9553 55.0948C78.9553 55.0948 69.7546 36.3147 85.0343 47.8129C100.314 59.3111 104.093 65.3881 104.093 65.3881L101.081 55.0948L85.0343 32.2087C85.0343 32.2087 85.0343 24.8169 94.1803 32.2087C103.326 39.6005 103.217 43.597 106.776 47.8129C110.336 52.0287 113.677 45.8966 113.677 45.8966L106.776 21.8607C106.248 -2.73132 107.756 -6.43974 116.689 21.8607C121.597 29.6494 121.851 37.7621 122.44 52.0287C121.717 57.4829 120.492 60.9621 113.677 69.5492V83.6751C123.85 78.309 129.024 77.5111 137.719 78.3094C146.162 79.403 150.886 80.476 159.078 94.3516L165.924 106.178C165.924 106.178 171.62 110.01 175.07 106.178C178.52 102.345 178.813 99.1185 183.504 96.2679C190.665 96.1101 193.334 97.2208 194.567 102.345V113.405C196.437 120.383 192.675 122.371 188.816 130.214C184.506 136.287 180.374 137.903 170.524 138.207C168.374 144.815 164.757 147.815 156.778 152.717C165.39 165.515 168.695 175.148 172.441 195.806C172.655 206.61 171.546 213.218 163.24 227.835C159.097 235.059 158.856 237.799 163.24 239.661L170.524 250.518C174.867 254.892 185.88 332.967 183.504 343.032C171.88 352.678 173.326 332.107 163.24 343.032C164.242 347.529 151.393 253.177 147.371 264.464C143.824 266.353 143.879 313.356 139.965 309.469L142.265 330.439C148.358 339.629 150.07 344.649 149.549 353.325C142.818 355.561 139.082 355.529 132.352 353.325L126.657 343.032C128.454 324.82 126.449 313.791 120.523 293.482C119.595 291.199 119.744 286.724 120.523 276.29V261.452C105.913 261.796 97.7221 261.459 83.1175 257.62C80.1483 271.351 76.5873 276.379 69.7546 284.667C61.3174 290.531 61.1529 300.521 64.4422 323.595C67.3011 333.357 70.398 338.794 79.722 348.398C79.1112 353.438 76.4238 354.68 69.7546 355.625C60.6307 356.097 57.795 355.623 57.2131 353.325C56.4637 346.721 54.4152 343.632 48.7791 338.871C46.5548 317.703 45.3077 305.835 43.0834 284.667C43.1794 280.851 31.6373 284.667 28.5704 293.482C25.5035 302.297 25.7666 318.109 23.9701 333.889C26.0138 340.649 27.5482 343.992 31.6373 348.398C32.2866 351.598 31.4514 353.148 28.5704 355.625C24.4454 357.386 21.8257 357.534 16.3576 355.625Z',
      'viewBox': Size(476, 759),
      'backgroundColor': Color(0xFFFFB6C1), // Light pink
    },
    {
      'name': 'Santa',
      'svgPath': 'M194.228 525.821C230.102 527.982 247.467 528.425 249.864 521.238L246.974 500.007C251.685 496.157 251.237 493.497 246.974 488.186C250.385 469.319 252.627 461.751 258.535 465.749C263.723 467.004 265.725 471.499 267.205 488.186C262.16 494.319 275.249 492.168 267.205 506.039C259.162 519.909 270.766 533.385 278.525 525.821H291.772C309.275 529.863 327.659 525.821 327.659 521.238C327.659 516.654 333.559 508.963 327.659 500.007C317.967 491.161 314.052 493.709 307.427 500.007C300.379 502.879 299.274 499.859 299.238 491.322C312.964 478.516 304.319 481.461 299.238 480.466C294.158 479.47 314.547 452.521 327.659 444.519C335.429 439.493 338.003 436.365 334.162 429.32C324.854 419.267 320.273 414.03 323.323 411.708C322.45 405.304 322.817 402.216 327.659 399.163C326.885 384.494 323.049 376.717 313.449 363.216C308.857 359.41 309.14 351.824 311.281 343.674L311.311 343.607C321.446 320.593 327.138 307.668 323.323 294.7C331.679 288.834 334.29 285.375 327.659 278.294C335.793 263.471 338.015 255.844 334.162 244.519C327.072 230.939 323.322 230.059 316.82 234.145C307.189 236.341 307.835 241.661 302.61 263.578C296.606 260.923 293.364 259.94 288.882 263.578C285.456 269.351 287.884 271.091 299.238 271.78C293.294 275.61 292.871 279.268 297.552 288.668C298.577 305.141 292.741 310.744 278.525 318.584C274.862 312.419 272.069 307.663 264.556 294.7C264.603 278.955 261.839 273.817 249.864 273.952C232.718 255.663 221.545 252.527 199.767 255.375C183.367 257.206 177.25 262.857 167.012 273.952C157.431 285.429 156.378 293.468 158.823 309.416C153.075 322.898 158.689 324.793 170.865 326.787C177.86 318.604 178.443 314.681 170.865 309.416C176.07 294.442 179.645 294.528 186.761 304.35C180.182 318.03 182.343 322.669 194.228 326.787C196.156 334.009 197.141 338.027 194.228 343.674L178.573 360.562C163.104 373.418 158.598 384.597 153.524 407.365C141.35 409.284 142.045 413.497 147.021 422.564L141 444.519C144.876 458.68 148.322 463.649 158.823 462.371C168.115 457.311 171.017 452.432 170.865 438.97L175.682 444.519C182.007 441.297 182.113 437.696 178.573 429.32C181.736 423.949 181.122 420.938 178.573 415.568L191.097 394.82V422.564L183.871 435.833C179.134 447.423 181.51 452.794 199.767 459.235C211.374 467.595 212.836 472.227 213.255 480.466C206.81 479.635 206.787 481.994 213.255 491.322V500.007C196.009 490.524 189.172 490.593 183.871 503.867C180 515.1 178.495 521.174 194.228 525.821Z',
      'viewBox': Size(476, 759),
      'backgroundColor': Color(0xFF228B22), // Dark green
    },
    {
      'name': 'Cookie man',
      'svgPath': 'M168.329 328.629C166.448 328.471 127.057 351.921 154.958 367.628C182.859 383.336 199.903 372.537 193.958 404.028C188.013 435.52 176.501 445.814 176.501 445.814C156.639 446.73 149.111 450.043 146.787 464.571C156.592 491.703 163.637 503.837 193.958 490.2L237.044 464.571C253.349 469.429 262.208 474.781 277.344 490.2C295.144 498.564 305.777 499.074 327.115 484.814C336.602 462.369 330.329 450.218 304.272 445.814C283.247 425.701 277.341 413.014 282.729 386.571L327.115 367.628C335.654 337.498 327.883 330.299 304.272 328.629L273.258 338.1C282.595 322.095 285.16 313.487 282.729 299.1C273.238 277.891 264.632 269.148 246.329 264C226.043 264.708 215.948 267.036 204.729 281.457C192.02 295.152 195.011 309.537 204.729 338.1C189.878 332.127 181.641 329.096 168.329 328.629Z',
      'viewBox': Size(476, 759),
      'backgroundColor': Color(0xFFDC143C), // Bright red
    },
    {
      'name': 'Christmas tree',
      'svgPath': 'M259.685 543V509.544C259.685 505.514 285.462 524.882 301.123 525.569L295.592 509.544C323.001 519.266 351.936 514.604 356.905 506.639C361.873 498.673 341.455 499.784 332.529 498.579C375.342 473.873 378.462 467.611 367.873 465.217C345.024 468.718 309.95 454.012 320.061 457.72C330.171 461.428 377.673 431.91 365.436 420.328C353.198 408.745 324.586 423.214 298.592 414.892C316.585 408.376 329.53 395.962 328.029 390.995C326.529 386.028 295.592 391.463 295.592 385.466C295.592 379.468 330.79 371.24 323.998 354.071L305.06 356.602C290.874 354.665 274.685 344.138 274.685 344.138C274.685 344.138 301.123 331.111 298.592 327.175C296.06 323.239 284.693 329.559 280.123 323.146C293.525 316.401 301.123 305.246 298.592 301.779C296.06 298.311 280.374 305.081 268.685 298.78C260.009 293.034 256.17 285.214 249.747 269.353L268.685 277.788L264.654 256.421L280.123 237.49L256.685 233.929L246.185 212L233.81 233.929L208.872 237.49L228.279 256.421L224.247 277.788L243.279 269.353L228.279 294.75C217.25 304.258 210.078 307.012 193.403 301.779C191.092 313.362 196.617 317.58 212.341 323.146C205.292 329.823 200.434 323.708 193.403 327.175C186.373 330.643 200.212 338.966 215.81 344.138C206.68 361.186 178.452 354.158 163.966 354.071C149.48 353.985 189.612 384.105 193.403 385.466C197.195 386.827 163.966 390.995 163.966 390.995C163.966 390.995 167.263 403.554 193.403 414.892C166.155 426.57 155.529 423.326 121.59 420.328C87.6521 417.329 164.814 452.169 170.903 457.72C176.992 463.27 136.59 463.343 121.59 464.28C106.59 465.217 158.245 496.159 158.434 498.579C158.624 501 130.444 504.682 134.997 509.544C156.282 525.201 192.297 507.735 196.872 506.639C201.447 505.543 196.872 513.105 188.903 525.569C180.935 538.033 227.804 510.856 233.81 509.544C239.816 508.232 233.81 543 233.81 543H259.685Z',
      'viewBox': Size(476, 759),
      'backgroundColor': Color(0xFF00008B), // Dark blue
    },
    {
      'name': 'Snow man',
      'svgPath': 'M187.468 376.934C181.225 394.763 183.764 403.326 194.041 417.231C185.97 420.834 181.136 427.116 172.32 440.951C164.096 456.436 162.315 466.777 164.603 488.107C165.79 507.63 172.095 518.336 194.041 536.977C206.934 548.886 215.897 552.044 234.339 552.695C254.92 553.765 266.292 552.314 286.07 543.55C303.104 533.906 310.777 527.547 316.936 512.399C327.371 490.534 329.075 481.601 326.939 469.816C324.505 442.328 316.073 432.835 298.645 417.231C308.327 395.053 307.769 385.873 303.218 371.79L341.515 351.499C341.515 351.499 358.092 358.929 364.951 355.214C371.811 351.499 364.951 347.498 364.951 347.498H345.231C345.231 347.498 352.661 340.067 359.807 337.495C366.952 334.923 359.807 329.779 359.807 329.779L326.939 351.499L332.084 337.495C332.084 337.495 341.801 327.206 349.232 323.205C356.663 319.204 349.232 315.775 349.232 315.775L326.939 331.779L321.795 351.499L298.645 364.645C293.247 348.696 287.845 345.674 277.496 342.068C292.455 317.921 295.737 304.702 282.354 282.337C295.719 280.448 298.209 278.348 298.645 273.764L272.923 269.762C265.64 255.319 265.384 246.615 269.779 230.323C250.998 225.859 240.463 223.39 219.763 230.323C220.865 239.65 221.8 243.556 224.336 246.899L219.763 267.762L194.041 273.764C189.639 277.346 194.037 279.197 208.617 282.337C195.804 304.567 196.615 317.641 213.762 342.068C203.041 343.92 197.74 348.948 190.04 367.789C177.177 367.41 169.8 360.823 156.601 347.498L152.6 337.495C152.6 337.495 147.455 330.636 147.455 323.205C147.455 315.775 137.452 319.776 137.452 319.776L144.883 329.779L147.455 342.068L117.732 331.779C112.732 332.835 114.043 334.893 126.306 342.068L152.6 355.214L132.879 360.072C135.51 364.961 139.414 365.359 152.6 360.072L164.603 364.645C175.546 373.553 180.343 375.819 187.468 376.934Z',
      'viewBox': Size(476, 759),
      'backgroundColor': Color(0xFF8B4513), // Dark brown
    },
    {
      'name': 'Snowflake',
      'svgPath': 'M251.147 468V456.874L255.559 461.515L262.176 454.077L249.478 442.475V433.967L262.176 444.439L267.958 438.548L249.478 420.877V413.023L266.587 428.136L270.462 425.458V403.206L275.47 406.895V432.301H284.829V417.605L290.374 422.365V439.976H302.237V433.967L308.318 439.976L315.233 432.301L308.318 425.458H315.233V415.344H297.825L293.414 409.989H306.41V399.577H282.326L278.212 395.114H300.568L302.237 389.819L287.333 374.706H293.414L312.431 392.377L320.181 385.832L308.318 374.706H317.737L332.044 387.498L338.125 380.953L332.044 374.706H342V364.71H332.044L338.125 358.404L332.044 350.966L317.737 364.71L309.987 363.52L320.181 353.346L312.431 346.087L293.414 363.52H287.333L302.237 348.765L300.568 343.112H278.212L282.326 339.364H306.41V328.476H293.414L297.825 323.597H315.233V313.72H308.318L315.233 306.818L308.318 299.678L300.568 306.818V298.012H290.374V316.219L284.829 320.622V306.818H275.47V331.629L270.462 336.33V312.352L266.587 310.15L249.478 328.476V320.622L267.958 301.582L260.507 294.145L249.478 305.212V296.108L262.712 282.84L256.393 275.998L249.478 282.84V271H239.999V281.234L234.097 275.998L227.54 282.84L239.999 296.108V305.212L227.54 294.145L221.638 299.678L239.999 318.42V326.393L223.486 309.853H219.67V336.33L214.424 331.629V306.818H203.932V320.622L199.223 316.219V298.012H188.909L187.717 305.212L181.279 299.678L173.767 306.818L181.279 312.352L173.767 313.72V323.597H190.757L196.123 328.476H182.352V339.364H206.555L210.788 343.112H187.717L185.392 346.087L201.905 363.52H194.453L176.092 346.087L169.356 353.346L179.55 364.71H172.157L158.863 350.966L151.411 358.404L156.777 364.71H147V374.706H156.777L151.411 380.953L158.863 387.498L172.157 374.706H179.55L169.356 385.832L177.463 392.377L194.453 374.706H201.905L185.392 389.819L187.717 395.114H210.788L206.555 399.577H182.352V409.989H196.123L190.757 415.344H173.767V425.458H180.98L173.767 433.967L182.352 439.976L188.909 433.967V441.166L197.375 442.475V425.458L203.932 417.605L205.244 433.967H214.424V408.442L221.638 403.206V425.458H227.54L239.999 413.023V420.877L221.638 438.548L229.507 445.748L239.999 433.967V442.475L227.54 456.874L234.097 463.419L239.999 456.874V468H251.147Z',
      'viewBox': Size(476, 759),
      'backgroundColor': Color(0xFFFFD700), // Golden yellow
    },
  ];


  @override
  void initState() {
    super.initState();
    
    // Initialize progress animation
    _progressAnimationController = AnimationController(
      duration: Duration(seconds: 2),
      vsync: this,
    );
    _progressAnimation = Tween<double>(
      begin: 0.25,
      end: 0.5, // 50% progress for Christmas cutout selection page
    ).animate(CurvedAnimation(
      parent: _progressAnimationController!,
      curve: Curves.easeInOut,
    ));
    
    // Start the animation
    _progressAnimationController!.forward();
  }

  @override
  void dispose() {
    _progressAnimationController?.dispose();
    super.dispose();
  }


  @override
  Widget build(BuildContext context) {

    return NavLogPage(
      title: 'Christmas',
      showBackButton: true,
      selectedIndex: 2, // Dashboard index
      // Using default navigation handler from NavLogPage
      body: Column(
        children: [
          // Progress bar at the top
          Container(
            padding: EdgeInsets.symmetric(horizontal: 20, vertical: 16),
            child: Row(
              children: [
                Expanded(
                  child: Container(
                    height: 10,
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(5),
                      color: Colors.grey[200],
                    ),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(5),
                      child: AnimatedBuilder(
                        animation: _progressAnimation ?? const AlwaysStoppedAnimation(0.0),
                        builder: (context, child) {
                          return LinearProgressIndicator(
                            value: _progressAnimation?.value ?? 0.0,
                            backgroundColor: Colors.transparent,
                            valueColor: AlwaysStoppedAnimation<Color>(Color(0xFF23C4F7)),
                          );
                        },
                      ),
                    ),
                  ),
                ),
                SizedBox(width: 16),
                AnimatedBuilder(
                  animation: _progressAnimation ?? const AlwaysStoppedAnimation(0.0),
                  builder: (context, child) {
                    return Text(
                      '${((_progressAnimation?.value ?? 0.0) * 100).toInt()}%',
                      style: TextStyle(
                        fontSize: 14,
                        fontWeight: FontWeight.bold,
                        color: Color(0xFF23C4F7),
                      ),
                    );
                  },
                ),
              ],
            ),
          ),
          
          // Main content
          Expanded(
            child: Padding(
              padding: const EdgeInsets.all(16.0),
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  const Text(
                    'Choose a Christmas cutout to color',
                    style: TextStyle(fontSize: 24, fontWeight: FontWeight.bold),
                  ),

                  const SizedBox(height: 56),
                  Expanded(
                    child: GridView.count(
                      crossAxisCount: 2,
                      childAspectRatio: 0.75,
                      children: _christmasCutouts.map((cutout) {
                        return _buildChristmasCutoutCard(context, cutout);
                      }).toList(),
                    ),
                  ),
                ],
              ),
            ),
          ),
        ],
      ),
    );
  }

  Widget _buildChristmasCutoutCard(BuildContext context, Map<String, dynamic> cutout) {
    return GestureDetector(
      onTap: () {
        _navigateToChristmasColoring(cutout);
      },
      child: Card(
        elevation: 4,
        shape: RoundedRectangleBorder(
          borderRadius: BorderRadius.circular(12),
        ),
        child: Column(
          children: [
            Expanded(
              child: Container(
                decoration: BoxDecoration(
                  color: cutout['backgroundColor'] as Color,
                  borderRadius: const BorderRadius.vertical(top: Radius.circular(12)),
                ),
                child: Center(
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: CustomPaint(
                      size: Size(200, 200),
                      painter: ChristmasCutoutPreviewPainter(
                        svgPath: cutout['svgPath'] as String,
                        viewBox: cutout['viewBox'] as Size,
                      ),
                    ),
                  ),
                ),
              ),
            ),
            Container(
              width: double.infinity,
              padding: const EdgeInsets.all(8.0),
              decoration: BoxDecoration(
                color: Colors.white,
                borderRadius: BorderRadius.vertical(bottom: Radius.circular(12)),
              ),
              child: Text(
                cutout['name'],
                style: TextStyle(
                  fontWeight: FontWeight.bold,
                  fontSize: 16,
                  color: Colors.black,
                ),
                textAlign: TextAlign.center,
                overflow: TextOverflow.ellipsis,
              ),
            ),
          ],
        ),
      ),
    );
  }

  void _navigateToChristmasColoring(Map<String, dynamic> cutout) {
    // Track the activity
    trackClick('christmas_${cutout['name'].toString().toLowerCase().replaceAll(' ', '_')}');

    // Navigate to Christmas coloring page with the selected cutout
    Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => ChristmasColoringPage(
          cutoutName: cutout['name'],
          svgPath: cutout['svgPath'] as String,
          viewBox: cutout['viewBox'] as Size,
          backgroundColor: cutout['backgroundColor'] as Color,
        ),
      ),
    );
  }



  String get pageName => 'Christmas';
}

/// Painter for preview of Christmas cutout in selection grid
class ChristmasCutoutPreviewPainter extends CustomPainter {
  final String svgPath;
  final Size viewBox;

  ChristmasCutoutPreviewPainter({
    required this.svgPath,
    required this.viewBox,
  });

  @override
  void paint(Canvas canvas, Size size) {
    final path = ChristmasSVGParser.parseSVGPath(svgPath, viewBox: viewBox);
    final transformedPath = ChristmasSVGParser.transformPath(path, size, viewBox);
    
    final paint = Paint()
      ..color = Colors.white
      ..style = PaintingStyle.stroke
      ..strokeWidth = 2.0;
    
    canvas.drawPath(transformedPath, paint);
  }

  @override
  bool shouldRepaint(covariant CustomPainter oldDelegate) => false;
}

